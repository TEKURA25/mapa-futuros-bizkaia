<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Futuros que se cultivan en Bizkaia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Overlay para mostrar la ficha en grande */
    #pdf-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #pdf-container {
      position: relative;
      width: 90%;
      height: 90%;
      background: #111;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #pdf-frame {
      flex: 1;
      width: 100%;
      border: none;
      background: #111;
    }

    #close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      z-index: 1001;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 20px;
      cursor: pointer;
    }

    #close-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .emoji-icon {
      background: transparent !important;
      border: none !important;
    }

    .pais-vasco-label {
      background: rgba(255, 255, 255, 0.8);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #333;
    }

    .leaflet-tooltip {
      font-size: 11px;
      padding: 2px 5px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Overlay para el PDF -->
<div id="pdf-overlay">
  <div id="pdf-container">
    <button id="close-btn" title="Cerrar ficha">✕</button>
    <iframe id="pdf-frame" src=""></iframe>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<script>
  const PDF_FILE = "Resumen de fichas.pdf";

  // Lista de iniciativas (páginas del PDF actualizadas)
  const iniciativas = [
    // Elorrio
    { name: "Belaze (Elorrio)",                     lat: 43.135,   lng: -2.560,   page: 1,  video: false, collab: false, municipio: false },
    { name: "Delikatetxe (Elorrio)",                lat: 43.125,   lng: -2.530,   page: 2,  video: false, collab: false, municipio: false },

    // Durango
    { name: "Etartie Denda (Durango)",              lat: 43.171,   lng: -2.633,   page: 3,  video: true,  collab: true,  municipio: false },

    // Amorebieta
    { name: "Ibarra Baserria (Amorebieta-Etxano)",  lat: 43.217,   lng: -2.733,   page: 4,  video: true,  collab: false, municipio: false },

    // Arrieta
    { name: "Biortzartxu (Arrieta)",                lat: 43.366,   lng: -2.780,   page: 5,  video: false, collab: false, municipio: false },

    // Gamiz-Fika y entorno
    { name: "Itturbaltza (Gamiz-Fika / Mungia)",    lat: 43.323,   lng: -2.840,   page: 6,  video: true,  collab: false, municipio: false },
    { name: "Biolandare (Gamiz-Fika)",              lat: 43.308,   lng: -2.832,   page: 7,  video: true,  collab: false, municipio: false },
    { name: "Luramak Bio (Gamiz-Fika)",             lat: 43.304,   lng: -2.845,   page: 8,  video: false, collab: false, municipio: false },

    { name: "Uribe Butroeko Sarea",                 lat: 43.354,   lng: -2.846,   page: 9,  video: false, collab: true,  municipio: false },

    // Maruri-Jatabe
    { name: "Mustai Ortua (Maruri-Jatabe)",         lat: 43.383,   lng: -2.853,   page:10,  video: false, collab: false, municipio: false },
    { name: "Germinados Kimuak (Maruri-Jatabe)",    lat: 43.389,   lng: -2.840,   page:11,  video: false, collab: false, municipio: false },

    // Iparlore (Barrio Urizar, aprox)
    { name: "Iparlore (Lemoiz)",                    lat: 43.414,   lng: -2.902,   page:12,  video: true,  collab: false, municipio: false },

    // Bermeo
    // Serrats – posición ajustada al edificio de Conservas Serrats en Landabaso
    { name: "Serrats (Bermeo)",                     lat: 43.42056, lng: -2.73611, page:13,  video: true,  collab: false, municipio: false },
    // Opescaya – lonja / puerto de Bermeo
    { name: "Opescaya (Lonja de Bermeo)",           lat: 43.4170,  lng: -2.7233,  page:14,  video: false, collab: true,  municipio: false },

    // LANEKO – Okamika Industrialdea
    { name: "Laneko S. Coop. (Okamika)",            lat: 43.3316,  lng: -2.5391,  page:15,  video: false, collab: true,  municipio: false },

    // Área metropolitana / Enkarterri
    { name: "Kondimenta (Leioa)",                   lat: 43.320,   lng: -2.970,   page:16,  video: false, collab: false, municipio: false },
    { name: "Bizkaiberries (Galdames)",             lat: 43.250,   lng: -3.120,   page:17,  video: false, collab: false, municipio: false },

    // Ama Orea – Cezura 21, Karrantza (aprox)
    { name: "Ama Orea (Karrantza)",                 lat: 43.206,   lng: -3.364,   page:18,  video: false, collab: false, municipio: false },

    // Orduña y ecosistema
    { name: "Ekoizpen (Municipio de Orduña)",       lat: 42.9958,  lng: -3.0112, page:19,  video: true,  collab: false, municipio: true  },

    { name: "Cocina Municipal de Orduña",           lat: 42.99253, lng: -3.00934,page:20,  video: false, collab: true,  municipio: false },
    { name: "Bedarbide",                            lat: 42.989,   lng: -3.018,  page:21,  video: false, collab: true,  municipio: false },
    { name: "Belardi (La Rondina, Orduña)",         lat: 42.98533, lng: -3.01451,page:22,  video: false, collab: true,  municipio: false },
    { name: "Orduñako Zaporeak",                    lat: 43.01079, lng: -3.02303,page:23,  video: false, collab: true,  municipio: false }
  ];

  // Crear mapa
  const map = L.map("map").setView([43.2, -2.9], 9);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // Etiqueta "País Vasco"
  const paisVascoControl = L.control({position: "bottomright"});
  paisVascoControl.onAdd = function () {
    const div = L.DomUtil.create("div", "pais-vasco-label");
    div.innerText = "País Vasco";
    return div;
  };
  paisVascoControl.addTo(map);

  // Overlay PDF
  const overlay   = document.getElementById("pdf-overlay");
  const pdfFrame  = document.getElementById("pdf-frame");
  const closeBtn  = document.getElementById("close-btn");

 function abrirFicha(page) {
  const url = `viewer.html?file=${encodeURIComponent(PDF_FILE)}&page=${encodeURIComponent(page)}`;

  // En pantallas pequeñas (móvil): abrir el visor a página completa (sin iframe)
  if (window.matchMedia("(max-width: 768px)").matches) {
    window.location.href = url;
    return;
  }

  // En escritorio: overlay con iframe
  pdfFrame.src = url;
  overlay.style.display = "flex";
}


  function cerrarFicha() {
    overlay.style.display = "none";
    pdfFrame.src = "";
  }

  closeBtn.addEventListener("click", cerrarFicha);
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) cerrarFicha();
  });

  // Generar pin SVG de color y tamaño variables
  function createPinIcon(color, size) {
    const width = size;
    const height = size * 1.4;

    const svg = `
      <svg width="${width}" height="${height}" viewBox="0 0 24 34" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.4"/>
          </filter>
        </defs>
        <g filter="url(#shadow)">
          <path
            d="M12 1 C7 1 3 5 3 10 C3 16 8 21 12 26 C16 21 21 16 21 10 C21 5 17 1 12 1 Z"
            fill="${color}"
            stroke="#333"
            stroke-width="1"
          />
          <circle cx="12" cy="10" r="4" fill="white" />
        </g>
      </svg>
    `;

    return L.divIcon({
      html: svg,
      className: "emoji-icon",
      iconSize: [width, height],
      iconAnchor: [width / 2, height],
      popupAnchor: [0, -height]
    });
  }

  // Añadir marcadores
  iniciativas.forEach((item) => {
    const color = item.video ? "#7b1433" : "#177a3b"; // granate / verde musgo
    const size = item.municipio
      ? 38  // municipio grande
      : (item.collab ? 32 : 26); // colaborativos / normales

    const icon = createPinIcon(color, size);

    const marker = L.marker([item.lat, item.lng], { icon }).addTo(map);

    marker.bindTooltip(item.name, {
      permanent: false,
      direction: "top",
      offset: [0, -4]
    });

    marker.on("click", () => abrirFicha(item.page));
  });
</script>
</body>
</html>
